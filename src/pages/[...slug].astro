---
import '../styles/global.css';
import App from '../App';
import { getSupabaseServer } from './api/_supabase';
import { getCoverPublicIdFromSlug } from '../lib/coverRoutes';

const logoUrl = `/cover_cafe_logo.svg`;

// ── Server-side SEO for cover pages ──────────────────────────────────────────
const slug = Astro.params.slug ?? '';
const isFanCoverPage      = /^covers\/fan\//.test(slug) || /^cover\//.test(slug);
const isOfficialCoverPage = /^covers\/official\//.test(slug);

interface CoverMeta {
  title: string;
  artist: string;
  year: number | null;
  imageUrl: string;
  isOfficial?: boolean;
}

let coverMeta: CoverMeta | null = null;

if (isFanCoverPage) {
  const coverSlug = slug.replace(/^covers\/fan\//, '').replace(/^cover\//, '');
  const publicId = getCoverPublicIdFromSlug(coverSlug);

  if (publicId !== null) {
    const supabase = getSupabaseServer();
    if (supabase) {
      const { data } = await supabase
        .from('covers_cafe_covers')
        .select('title, artist, year, storage_path, image_url')
        .eq('public_id', publicId)
        .eq('is_public', true)
        .eq('is_private', false)
        .single();

      if (data) {
        const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL as string;
        const imageUrl = data.storage_path
          ? `${supabaseUrl}/storage/v1/render/image/public/covers_cafe_covers/${data.storage_path}?width=600&height=600&resize=cover&quality=85`
          : (data.image_url as string);

        coverMeta = {
          title: data.title as string,
          artist: data.artist as string,
          year: (data.year as number | null) ?? null,
          imageUrl,
        };
      }
    }
  }
}

if (isOfficialCoverPage) {
  const coverSlug = slug.replace(/^covers\/official\//, '');
  const publicId = getCoverPublicIdFromSlug(coverSlug);

  if (publicId !== null) {
    const supabase = getSupabaseServer();
    if (supabase) {
      const { data } = await supabase
        .from('covers_cafe_official_covers')
        .select('album_title, artist_name, release_year, album_cover_url')
        .eq('official_public_id', publicId)
        .single();

      if (data) {
        coverMeta = {
          title: data.album_title as string,
          artist: data.artist_name as string,
          year: (data.release_year as number | null) ?? null,
          imageUrl: data.album_cover_url as string,
          isOfficial: true,
        };
      }
    }
  }
}

// ── Build final meta values ───────────────────────────────────────────────────
const yearSuffix = coverMeta?.year ? ` (${coverMeta.year})` : '';

const pageTitle = coverMeta
  ? coverMeta.isOfficial
    ? `${coverMeta.title} by ${coverMeta.artist}${yearSuffix} - Official Album Art | covers.cafe`
    : `${coverMeta.title} by ${coverMeta.artist}${yearSuffix} - Album Cover Art | covers.cafe`
  : 'covers.cafe';

const pageDescription = coverMeta
  ? coverMeta.isOfficial
    ? `View official album artwork for ${coverMeta.title} by ${coverMeta.artist}${yearSuffix}. Discover community fan covers on covers.cafe.`
    : `Download and view the ${coverMeta.title} album cover art by ${coverMeta.artist}${yearSuffix}. Discover and download high-quality album artwork on covers.cafe.`
  : 'Upload and discover album cover art at covers.cafe';

const ogImage = coverMeta?.imageUrl ?? null;
const canonicalUrl = new URL(Astro.url.pathname, Astro.url.origin).href;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="icon" type="image/svg+xml" href={logoUrl} />

    <!-- Open Graph -->
    <meta property="og:site_name" content="covers.cafe" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogImage && <meta property="og:image:width" content="600" />}
    {ogImage && <meta property="og:image:height" content="600" />}
    {ogImage && <meta property="og:image:alt" content={coverMeta ? `${coverMeta.title} by ${coverMeta.artist} album cover art` : 'Album cover art'} />}

    <!-- Twitter / X Card -->
    <meta name="twitter:card" content={ogImage ? 'summary_large_image' : 'summary'} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}
    {ogImage && <meta name="twitter:image:alt" content={coverMeta ? `${coverMeta.title} by ${coverMeta.artist} album cover art` : 'Album cover art'} />}

    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      (function () {
        var t = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        var noThemeImages = localStorage.getItem('pref_no_theme_images') === '1';
        var gridMinWidth = parseInt(localStorage.getItem('pref_cover_grid_min_width') || '160', 10);
        if (!isFinite(gridMinWidth)) gridMinWidth = 160;
        document.documentElement.setAttribute('data-theme', t);
        document.documentElement.setAttribute('data-no-theme-images', noThemeImages ? 'true' : 'false');
        document.documentElement.style.setProperty('--cover-grid-min-width', gridMinWidth + 'px');
      })();
    </script>
  </head>
  <body>
    <App client:only="react" />
  </body>
</html>
